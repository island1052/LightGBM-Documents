---
title: "LightGBM for Classification"
author: "Guanjinghui Xu"
date: "2026-01-31"
output: html_document
---

# LightGBM for Classification Manual Version

## 第一阶段：数据准备与样本权重

-   **处理类别变量**：利用 `lgb.convert_with_rules` 编码人口统计学特征。

-   **计算权重 (`weight_param.R`)**：针对不平衡数据（如病人数远少于对照组），计算各类别权重并注入 `lgb.Dataset`。

## 第二阶段：模型优化与训练

-   **贝叶斯调参**：配合 `lgb.cv` 和 `early_stopping_rounds` 寻找最优参数。

-   **训练最终模型**：使用最优 `nrounds` 产出最终预测器。

## 第三阶段：性能诊断 (新增模块)

在得到预测概率后，进行以下可视化：

### 1. 混淆矩阵 (Confusion Matrix)

-   **逻辑**：将预测概率以 0.5（或通过约登指数确定的最佳阈值）为界转为类别。

-   **科研意义**：清晰显示“误诊”和“漏诊”的数量，特别是配合样本权重后，观察对少数类的识别提升。

### 2. ROC 曲线与 AUC 值

-   **逻辑**：通过计算不同阈值下的真阳性率（TPR）和假阳性率（FPR）绘制曲线。

-   **科研意义**：AUC 指标不依赖于单一阈值，是评价神经影像/心理学模型分类能力最公允的指标。

## 第四阶段：深度解释 (SHAP & Permutation)

-   **SHAP Summary**：解释哪些特征推动了预测结果向“患病”或“健康”偏移。

-   **Permutation Importance**：验证特征的真实预测贡献。
